version: "3.9"

services:
  fix-permissions:
    image: busybox
    command: sh -c "chmod -R 777 /data"
    volumes:
      - ./data:/data

  init-downloader:
    depends_on:
      fix-permissions:
        condition: service_completed_successfully
    image: curlimages/curl:latest
    container_name: imdb-downloader
    command: >
      sh -c "
        mkdir -p /data &&
        cd /data &&
        files='
          title.basics.tsv.gz
          title.akas.tsv.gz
          title.principals.tsv.gz
          title.crew.tsv.gz
          title.episode.tsv.gz
          title.ratings.tsv.gz
          name.basics.tsv.gz
        ' &&
        for f in $$files; do
          if [ -f \"$$f\" ]; then
            # Validate existing file
            if gzip -t \"$$f\" 2>/dev/null; then
              echo \"$$f already exists and is valid, skipping\";
            else
              echo \"$$f exists but is corrupted, re-downloading...\";
              rm -f \"$$f\";
              echo \"Downloading $$f ...\";
              curl -L --retry 3 --retry-delay 5 -O https://datasets.imdbws.com/$$f;
              # Validate downloaded file
              if ! gzip -t \"$$f\" 2>/dev/null; then
                echo \"Failed to download valid $$f, removing\";
                rm -f \"$$f\";
              fi
            fi
          else
            echo \"Downloading $$f ...\";
            curl -L --retry 3 --retry-delay 5 -O https://datasets.imdbws.com/$$f;
            # Validate downloaded file
            if ! gzip -t \"$$f\" 2>/dev/null; then
              echo \"Failed to download valid $$f, removing\";
              rm -f \"$$f\";
            fi
          fi;
        done
      "
    volumes:
      - ./data:/data

  wait-for-data:
    image: postgres:15
    container_name: imdb-wait-for-data
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: imdb
      DB_USER: imdb
    command: >
      sh -c "
        until pg_isready -h $$DB_HOST -p $$DB_PORT -U $$DB_USER; do
          echo 'Waiting for database to be ready...'
          sleep 2
        done
        
        echo 'Checking if data import is complete...'
        until psql -h $$DB_HOST -p $$DB_PORT -U $$DB_USER -d $$DB_NAME -c \"SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'title_basics';\" | grep -q '^[1-9]'; do
          echo 'Waiting for data import to complete...'
          sleep 5
        done
        
        echo 'Waiting for data to be imported...'
        until psql -h $$DB_HOST -p $$DB_PORT -U $$DB_USER -d $$DB_NAME -c \"SELECT COUNT(*) FROM title_basics LIMIT 1;\" | grep -q '^[1-9]'; do
          echo 'Waiting for data import to start...'
          sleep 10
        done
        
        echo 'âœ… Database is ready with imported data!'
      "
    depends_on:
      db:
        condition: service_healthy
    networks:
      - default

  db:
    image: postgres:15
    container_name: imdb-db
    environment:
      POSTGRES_DB: imdb
      POSTGRES_USER: imdb
      POSTGRES_PASSWORD: imdb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d
      - ./data:/docker-entrypoint-initdb.d/imdb   # CRITICAL FIX
    depends_on:
      init-downloader:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    image: 1rptr1/imdb-backend:latest
    container_name: imdb-backend
    ports:
      - "8080:8080"
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: imdb
      DB_USER: imdb
      DB_PASSWORD: imdb
    depends_on:
      wait-for-data:
        condition: service_completed_successfully
    restart: unless-stopped

  frontend:
    image: 1rptr1/imdb-frontend:latest
    container_name: imdb-frontend
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_started

  suggestor:
    image: 1rptr1/imdb-suggestor:latest
    container_name: imdb-suggestor
    ports:
      - "9000:9000"
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: imdb
      DB_USER: imdb
      DB_PASSWORD: imdb
    depends_on:
      wait-for-data:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  postgres_data:
